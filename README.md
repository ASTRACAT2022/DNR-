
# ASTRACAT DNR: Рекурсивный DNS-Сервер

`ASTRACAT DNR` — это рекурсивный DNS-сервер. Он предназначен для быстрого разрешения DNS-имён путём выполнения полной рекурсивной цепочки запросов.

## Особенности

*   **Рекурсивный резолвер:** Самостоятельно проходит путь от корневых DNS-серверов до authoritative серверов для получения ответа.
*   **Кэширование:** Сохраняет результаты запросов в памяти, учитывая TTL (Time To Live) для повышения производительности.
*   **Предзапросы (Proactive Refresh):** Активно обновляет записи в кэше до истечения их срока жизни, чтобы минимизировать задержки для клиентов.
*   **Настраиваемый:** Поддерживает широкий спектр параметров командной строки для тонкой настройки поведения.
*   **Логирование:** Использует `syslog` для записи логов и статистики.

## Сборка из исходного кода

### Предварительные требования

*   **Компилятор C++:** `g++` или `clang++`.
*   **Make:** Для автоматизации сборки.
*   **Библиотека `libresolv`:** Для работы с DNS-пакетами. Обычно входит в состав пакета разработки `libc` (например, `libc6-dev` в Debian/Ubuntu).
*   **Autotools (если используется `configure.ac`):** `autoconf`, `automake`, `libtool`.

### Шаги сборки

1.  **Установите зависимости (пример для Debian/Ubuntu):**
    ```bash
    sudo apt-get update
    sudo apt-get install build-essential libc6-dev # autoconf automake libtool (если нужно)
    ```

2.  **Подготовьте среду сборки (если есть `configure.ac`):**
    Если в проекте присутствуют файлы `configure.ac` и `Makefile.am`, выполните:
    ```bash
    autoreconf -fiv
    ```
    *   Если возникнут ошибки, связанные с `install.sh`, проверьте файлы `Makefile.am` или `BUG.am` и замените в них `install.sh` на `install-sh`, либо удалите упоминание `install.sh`, если оно не требуется. Затем повторите `autoreconf -fiv`.

3.  **Настройка и сборка (с использованием Autotools):**
    ```bash
    # При необходимости укажите опции, например, префикс установки: ./configure --prefix=/usr/local
    ./configure
    make
    ```
    Исполняемый файл `DNR` будет создан в каталоге `src/`.

4.  **(Альтернатива) Прямая компиляция (если Autotools не используются или не работают):**
    Если сборка напрямую через `g++`:
    *   Убедитесь, что в файле `src/DNR.cpp` (или аналогичном) добавлены необходимые заголовки:
        ```cpp
        #include <ctime>  // Для srand(time(0))
        #include <time.h> // Для clock_gettime и CLOCK_MONOTONIC
        ```
    *   Скомпилируйте:
        ```bash
        cp ./config.h ./src/config.h
        g++ -Wall -O2 -o src/DNR src/DNR.cpp -lresolv -lrt
        ```
        *(Уточните имя исходного файла и флаги, если они отличаются)*

## Конфигурация и запуск

### Базовый запуск

`DNR` требует привилегий `root` для открытия порта 53:

```bash
sudo ./src/DNR
```

Это запустит сервер на всех сетевых интерфейсах (`0.0.0.0`) на порту 53 с настройками по умолчанию.

### Параметры командной строки

Просмотреть все доступные опции можно с помощью:

```bash
./src/DNR -h
```

Основные параметры:

*   `-b <address>`: IP-адрес для прослушивания (по умолчанию: `0.0.0.0`).
*   `-p <port>`: Порт для прослушивания (по умолчанию: `53`).
*   `-r <server>`: Адрес корневого DNS-сервера. Можно указать несколько раз. Если указать публичные DNS (например, `8.8.8.8`), сервер будет работать как forwarder.
*   `-t <ttl>`: TTL в секундах. Если до истечения кэшированной записи осталось меньше этого времени, сервер инициирует обновление (по умолчанию: `180`).
*   `-i <interval>`: Интервал проверки записей на обновление в секундах (по умолчанию: `60`).
*   `-n <min>`: Минимальный оригинальный TTL записи, чтобы она подлежала обновлению (по умолчанию: `900`).
*   `-s <soft>`: "Мягкий" предел размера кэша. При превышении записи обновляются только если они недавно использовались или являются NS/A-записями (по умолчанию: `50000`).
*   `-l <lru>`: Время в секундах, в течение которого запись считается "недавно использованной" (по умолчанию: `604800` - 7 дней).
*   `-d <hard>`: "Жесткий" предел размера кэша. При превышении обновляются только NS/A-записи (по умолчанию: `100000`).
*   `-o <timeout>`: Таймаут для всего запроса в секундах (по умолчанию: `5`).
*   `-q <timeout>`: Таймаут для повторной отправки запроса к одному серверу в миллисекундах (по умолчанию: `500`).
*   `-y <retry>`: Количество попыток повторной отправки запроса при таймауте (по умолчанию: `3`).
*   `-v`: Увеличить уровень детализации логов. Можно указывать несколько раз.

### Примеры запуска

*   **Запуск на порту 5353:**
    ```bash
    sudo ./src/DNR -p 5353
    ```
*   **Запуск на определенном IP (например, только localhost):**
    ```bash
    sudo ./src/DNR -b 127.0.0.1 -p 53
    ```
*   **Использование публичных DNS как корневых (режим forwarder):**
    ```bash
    sudo ./src/DNR -r 8.8.8.8 -r 8.8.4.4
    ```
*   **Запуск с более подробным логированием:**
    ```bash
    sudo ./src/DNR -v -v
    ```

### Просмотр статистики

Во время работы сервера можно отправить ему сигнал `SIGUSR1`, чтобы он записал статистику (количество запросов, ответов, размер кэша и т.д.) в системный лог (`syslog`):

```bash
# Найдите PID процесса DNR (например, с помощью ps aux | grep DNR)
kill -USR1 <PID_DNR>
# Затем проверьте syslog, например: tail /var/log/syslog или journalctl -f
```

### Тестирование

После запуска сервера его можно протестировать с помощью `dig`:

```bash
# Если сервер запущен на порту 53 стандартного интерфейса
dig @127.0.0.1 example.com

# Если сервер запущен на порту 5353
dig @127.0.0.1 -p 5353 example.com
```

## Управление как системный сервис (systemd)

Чтобы `DNR` автоматически запускался при загрузке системы и управлялся через `systemctl`, создайте unit-файл.

1.  **(Рекомендуется) Переместите исполняемый файл:**
    Для лучшей практики переместите `DNR` в системный каталог:
    ```bash
    sudo cp ./src/DNR /usr/local/bin/
    sudo chmod +x /usr/local/bin/DNR
    ```

2.  **Создайте unit-файл:**
    Создайте файл `/etc/systemd/system/dnr.service`:
    ```bash
    sudo nano /etc/systemd/system/dnr.service
    ```

3.  **Добавьте содержимое unit-файла:**
    ```ini
    [Unit]
    Description=ASTRACAT DNR Recursive DNS Server
    After=network.target

    [Service]
    Type=simple
    # Рекомендуется создать пользователя 'dnr' и запускать от него
    # User=dnr
    # Group=dnr
    # Если запускаете от root (не рекомендуется для продакшена):
    User=root
    Group=root

    ExecStart=/usr/local/bin/DNR -p 5353 -b 0.0.0.0
    Restart=on-failure

    StandardOutput=journal
    StandardError=journal
    SyslogIdentifier=dnr

    [Install]
    WantedBy=multi-user.target
    ```
    *   **Важно:** Убедитесь, что путь в `ExecStart` правильный (`/usr/local/bin/DNR`).
    *   **Порт:** В примере используется `-p 5353`. Измените на `-p 53`, если нужно, и учтите, что для порта 53 потребуются права `root` или `CAP_NET_BIND_SERVICE`.

4.  **Перезагрузите конфигурацию systemd:**
    ```bash
    sudo systemctl daemon-reload
    ```

5.  **Управляйте сервисом:**
    ```bash
    # Включить автозапуск
    sudo systemctl enable dnr.service

    # Запустить сервис
    sudo systemctl start dnr.service

    # Проверить статус
    sudo systemctl status dnr.service

    # Остановить сервис
    sudo systemctl stop dnr.service

    # Перезапустить сервис
    sudo systemctl restart dnr.service

    # Просмотр логов
    sudo journalctl -u dnr.service
    sudo journalctl -u dnr.service -f # Следить в реальном времени
    ```

---
